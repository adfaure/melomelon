image: nixos/nix:latest

stages:
  - build
  - prepare
  - release

build_and_test:
  stage: build
  script:
    # Build the extension
    - nix-build default.nix -A melomelon
    - mkdir melomelon-chrome-extension
    # Copy the result out of the nix store
    - cp -r result/* melomelon-chrome-extension

  artifacts:
    when: always
    expire_in: 8 hours
    paths:
      - melomelon-chrome-extension


release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build_and_test
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo 'running release_job for $CI_COMMIT_TAG'
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: 'Created using the release-cli $EXTRA_DESCRIPTION'
    tag_name: '$CI_COMMIT_TAG'
    ref: '$CI_COMMIT_SHA'
